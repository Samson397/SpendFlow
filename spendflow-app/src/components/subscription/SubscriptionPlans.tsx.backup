'use client';

import { Crown, Check, Star, Zap } from 'lucide-react';
import { useSubscription } from '@/contexts/SubscriptionContext';
import { useCurrency } from '@/contexts/CurrencyContext';
import { SubscriptionTier } from '@/types';
import toast from 'react-hot-toast';
import { useState, useEffect } from 'react';

interface PricingCardProps {
  tier: SubscriptionTier;
  isPopular?: boolean;
  isCurrentPlan?: boolean;
}

function PricingCard({ tier, isPopular, isCurrentPlan }: PricingCardProps) {
  const { upgradeToTier } = useSubscription();
  const { formatAmount } = useCurrency();

  // Get the theme for this specific tier
  const getTierTheme = (tierName: SubscriptionTier) => {
    const themes = {
      free: {
        primary: '#6b7280', // gray-500 - very muted
        secondary: '#4b5563', // gray-600 - basic gray
        accent: '#9ca3af', // gray-400 - dull gray
        border: '#6b7280', // gray-500 - basic borders
        bg: 'border-[var(--theme-accent)] bg-[var(--theme-secondary)]/10',
        iconBg: 'bg-[var(--theme-primary)]/20 text-[var(--theme-accent)]',
        button: 'bg-[var(--theme-primary)] hover:bg-[var(--theme-secondary)] text-slate-200'
      },
      pro: {
        primary: '#7c3aed', // violet-600 - vibrant purple
        secondary: '#6d28d9', // violet-700 - rich purple
        accent: '#a855f7', // violet-500 - bright purple
        border: '#6d28d9', // violet-700 - purple borders
        bg: 'border-[var(--theme-accent)] bg-[var(--theme-secondary)]/10',
        iconBg: 'bg-[var(--theme-primary)]/20 text-[var(--theme-accent)]',
        button: 'bg-[var(--theme-accent)] hover:bg-[var(--theme-primary)] text-white'
      },
      enterprise: {
        primary: '#059669', // emerald-600 - premium green
        secondary: '#047857', // emerald-700 - rich green
        accent: '#10b981', // emerald-500 - bright green
        border: '#047857', // emerald-700 - green borders
        bg: 'border-[var(--theme-accent)] bg-[var(--theme-secondary)]/10',
        iconBg: 'bg-[var(--theme-primary)]/20 text-[var(--theme-accent)]',
        button: 'bg-[var(--theme-accent)] hover:bg-[var(--theme-primary)] text-slate-900'
      }
    };
    return themes[tierName];
  };

  const tierTheme = getTierTheme(tier);

  const handleUpgrade = () => {
    if (!isCurrentPlan) {
      upgradeToTier(tier);
    }
  };

  const getTierIcon = (tierName: SubscriptionTier) => {
    switch (tierName) {
      case 'free':
        return <Star className="h-6 w-6" />;
      case 'pro':
        return <Zap className="h-6 w-6" />;
      case 'enterprise':
        return <Crown className="h-6 w-6" />;
      default:
        return <Star className="h-6 w-6" />;
    }
  };

  const getTierPrice = (tierName: SubscriptionTier) => {
    switch (tierName) {
      case 'free':
        return { price: 0, period: 'forever' };
      case 'pro':
        return { price: 4.99, period: 'per month' };
      case 'enterprise':
        return { price: 9.99, period: 'per month' };
      default:
        return { price: 0, period: 'forever' };
    }
  };

  const price = getTierPrice(tier);

  return (
    <div className={`relative p-6 sm:p-8 rounded-lg border backdrop-blur-sm transition-all duration-300 hover:shadow-lg ${tierTheme.bg}`}>
      {isPopular && (
        <div className="absolute -top-3 left-1/2 transform -translate-x-1/2">
          <div className="bg-amber-500 text-slate-900 px-3 py-1 rounded-full text-xs font-semibold flex items-center gap-1">
            <Crown className="h-3 w-3" />
            MOST POPULAR
          </div>
        </div>
      )}

      {isCurrentPlan && (
        <div className="absolute -top-3 left-1/2 transform -translate-x-1/2">
          <div className="bg-green-500 text-slate-900 px-3 py-1 rounded-full text-xs font-semibold flex items-center gap-1">
            <Check className="h-3 w-3" />
            CURRENT PLAN
          </div>
        </div>
      )}

      <div className="text-center mb-6">
        <div className={`inline-flex items-center justify-center w-12 h-12 rounded-full mb-4 ${tierTheme.iconBg}`}>
          {getTierIcon(tier)}
        </div>

        <h3 className="text-xl sm:text-2xl font-serif font-bold text-slate-100 mb-2">
          {tier === 'free' ? 'Essential' : tier === 'pro' ? 'Professional' : 'Enterprise'}
        </h3>

        <div className="mb-4">
          <span className="text-3xl sm:text-4xl font-serif font-bold text-slate-100">
            {price.price === 0 ? 'Free' : formatAmount(price.price)}
          </span>
          {price.price > 0 && (
            <span className="text-slate-400 text-sm ml-1">
              {price.period}
            </span>
          )}
        </div>
      </div>

      <ul className="space-y-3 mb-8">
        {(() => {
          const tierFeatures = {
            free: [
              'Up to 2 cards',
              'Basic transaction tracking',
              'Mobile app access',
              'Community support'
            ],
            pro: [
              'Up to 10 cards',
              'Unlimited transactions',
              'Advanced analytics',
              'Data export (CSV/PDF)',
              'Email support',
              'Multi-device sync'
            ],
            enterprise: [
              'Unlimited cards',
              'Unlimited transactions',
              'Advanced analytics & insights',
              'Custom reports & export',
              'Priority phone & email support',
              'API access',
              'Team collaboration',
              'Custom integrations',
              'Dedicated account manager'
            ]
          };
          return tierFeatures[tier].map((feature, index) => (
            <li key={index} className="flex items-start gap-3">
              <Check className="h-4 w-4 text-green-400 mt-0.5 shrink-0" />
              <span className="text-slate-300 text-sm">{feature}</span>
            </li>
          ));
        })()}
      </ul>

      <button
        onClick={handleUpgrade}
        disabled={isCurrentPlan}
        className={`w-full py-3 px-6 rounded-md font-semibold transition-all duration-200 ${
          isCurrentPlan
            ? 'bg-slate-700 text-slate-400 cursor-not-allowed'
            : isPopular
            ? 'bg-amber-500 hover:bg-amber-600 text-slate-900 shadow-lg hover:shadow-xl'
            : tierTheme.button
        }`}
      >
        {isCurrentPlan ? 'Current Plan' : `Upgrade to ${tier === 'free' ? 'Essential' : tier === 'pro' ? 'Professional' : 'Enterprise'}`}
      </button>
    </div>
  );
}

export function SubscriptionPlans() {
  const { tier, refreshSubscription } = useSubscription();
  const [actualTier, setActualTier] = useState<string>('loading');

  // Direct database check on component mount
  useEffect(() => {
    const checkActualTier = async () => {
      try {
        const auth = (await import('firebase/auth')).getAuth();
        const currentUser = auth.currentUser;
        
        if (!currentUser) {
          setActualTier('free');
          return;
        }

        const { usersService } = await import('@/lib/firebase/firestore');
        const userDoc = await usersService.get(currentUser.uid);
        
        const realTier = userDoc?.subscriptionTier || 'free';
        console.log('üéØ REAL DATABASE TIER:', realTier);
        setActualTier(realTier);
      } catch (error) {
        console.error('Error checking real tier:', error);
        setActualTier('free');
      }
    };

    checkActualTier();
  }, []);

  // Use the actual tier from database instead of context
  const displayTier = actualTier !== 'loading' ? actualTier : tier;

  const handleRefreshSubscription = async () => {
    console.log('üîÑ Refreshing subscription status...');
    try {
      await refreshSubscription();
      console.log('‚úÖ Subscription refreshed successfully');
    } catch (error) {
      console.error('‚ùå Error refreshing subscription:', error);
      // Fallback to page reload
      window.location.reload();
    }
  };

  const handleCheckDatabase = async () => {
    try {
      console.log('üîç Checking database and refreshing subscription...');
      await refreshSubscription();
      console.log('‚úÖ Subscription refresh completed');
    } catch (error) {
      console.error('‚ùå Error refreshing subscription:', error);
      // Fallback to page reload
      window.location.reload();
    }
  };

  const handleDirectCheck = async () => {
    console.log('üîç DIRECT DATABASE CHECK...');
    try {
      // Direct Firestore access
      const { doc, getDoc } = await import('firebase/firestore');
      const { db } = await import('@/firebase/config');
      const { useAuth } = await import('@/contexts/AuthContext');
      
      // Get current user
      const auth = (await import('firebase/auth')).getAuth();
      const currentUser = auth.currentUser;
      
      if (!currentUser) {
        console.error('No current user found');
        return;
      }
      
      console.log('üë§ Current user ID:', currentUser.uid);
      console.log('üìß Current user email:', currentUser.email);
      
      // Direct document access
      const userDocRef = doc(db, 'users', currentUser.uid);
      const userDocSnap = await getDoc(userDocRef);
      
      if (userDocSnap.exists()) {
        const userData = userDocSnap.data();
        console.log('üìÑ RAW Firestore document data:', userData);
        console.log('üè∑Ô∏è subscriptionTier field:', userData.subscriptionTier);
        console.log('üè∑Ô∏è subscriptionTier type:', typeof userData.subscriptionTier);
        console.log('üîç All document fields:', Object.keys(userData));
        
        if (userData.subscriptionTier === 'enterprise') {
          console.log('‚úÖ Document shows ENTERPRISE - UI should show Enterprise');
        } else {
          console.error('‚ùå Document shows:', userData.subscriptionTier, '- UI will show Essential/Free');
        }
      } else {
        console.error('‚ùå User document does not exist in Firestore!');
      }
      
    } catch (error) {
      console.error('‚ùå Error in direct database check:', error);
    }
  };

  const handleForceEnterprise = async () => {
    try {
      console.log('üöÄ Force setting subscription to Enterprise...');

      // Import required services
      const { usersService } = await import('@/lib/firebase/firestore');

      // Get current user (this is tricky in this component, but let's try)
      const auth = (await import('firebase/auth')).getAuth();
      const currentUser = auth.currentUser;

      if (!currentUser) {
        console.error('‚ùå No current user found');
        return;
      }

      console.log('üë§ Current user:', currentUser.uid, currentUser.email);
      console.log('üìù Updating user document with enterprise tier...');

      // Update the database
      await usersService.update(currentUser.uid, { subscriptionTier: 'enterprise' });

      console.log('‚úÖ Database update completed');

      // Verify the update worked
      console.log('üîç Verifying update...');
      const updatedUser = await usersService.get(currentUser.uid);
      console.log('üìÑ Updated user document:', updatedUser);
      console.log('üè∑Ô∏è Updated subscriptionTier:', updatedUser?.subscriptionTier);

      if (updatedUser?.subscriptionTier === 'enterprise') {
        console.log('‚úÖ Database update verified! Reloading page...');
        toast.success('Subscription set to Enterprise!');
      } else {
        console.error('‚ùå Database update failed! subscriptionTier is still:', updatedUser?.subscriptionTier);
        toast.error('Update failed - check console');
        return;
      }

      // Force page reload
      setTimeout(() => {
        console.log('üîÑ Reloading page...');
        window.location.reload();
      }, 1000);

    } catch (error) {
      console.error('‚ùå Error force updating subscription:', error);
      toast.error('Failed to update subscription');
    }
  };

  return (
    <div className="w-full px-4 sm:px-6 md:px-8 lg:px-12 xl:px-16 2xl:px-20 mx-auto space-y-8 sm:space-y-10 md:space-y-12">
      {/* Header */}
      <div className="text-center px-2 sm:px-4">
        <div className="w-8 sm:w-12 md:w-16 h-0.5 bg-linear-to-r from-transparent via-amber-400 to-transparent mx-auto mb-3 sm:mb-4 md:mb-8"></div>
        <h1 className="text-xl sm:text-2xl md:text-3xl lg:text-4xl xl:text-5xl font-serif text-slate-100 mb-2 sm:mb-4 tracking-wide">
          P R E M I U M   T I E R S
        </h1>
        <div className="w-12 sm:w-16 md:w-24 h-0.5 bg-linear-to-r from-transparent via-amber-400 to-transparent mx-auto mb-3 sm:mb-4 md:mb-6"></div>
        <p className="text-slate-400 text-xs sm:text-sm tracking-widest uppercase">Choose Your Perfect Plan</p>
        
        {/* DEBUG PANEL - TEMPORARY */}
        <div className="mt-4 p-4 bg-red-900/20 border border-red-700 rounded-lg">
          <h3 className="text-red-400 font-bold mb-2">üîß DEBUG PANEL</h3>
          <div className="text-xs space-y-1">
            <div>Context Tier: <span className="text-yellow-400">{tier}</span></div>
            <div>Display Tier: <span className="text-green-400">{displayTier}</span></div>
            <div>Actual Tier State: <span className="text-blue-400">{actualTier}</span></div>
          </div>
          <button
            onClick={async () => {
              console.log('üîç EMERGENCY DEBUG CHECK...');
              try {
                const auth = (await import('firebase/auth')).getAuth();
                const currentUser = auth.currentUser;
                console.log('üë§ User:', currentUser?.uid, currentUser?.email);
                
                const { doc, getDoc } = await import('firebase/firestore');
                const { db } = await import('@/firebase/config');
                
                if (currentUser) {
                  const userDocRef = doc(db, 'users', currentUser.uid);
                  const userDocSnap = await getDoc(userDocRef);
                  
                  if (userDocSnap.exists()) {
                    const data = userDocSnap.data();
                    console.log('üìÑ RAW DOC DATA:', data);
                    console.log('üè∑Ô∏è subscriptionTier:', data.subscriptionTier);
                    console.log('üè∑Ô∏è Type:', typeof data.subscriptionTier);
                    
                    // Force update the local state
                    setActualTier(data.subscriptionTier || 'free');
                    
                    alert(`Database shows: ${data.subscriptionTier || 'free'}\nUI now updated to: ${data.subscriptionTier || 'free'}`);
                  } else {
                    console.error('‚ùå No document found');
                    alert('No user document found!');
                  }
                } else {
                  alert('No current user!');
                }
              </tr>
              <tr>
                <td className="py-4 px-4 text-slate-300">Analytics</td>
                <td className="py-4 px-4 text-center text-red-400">‚úó</td>
                <td className="py-4 px-4 text-center text-green-400">‚úì</td>
                <td className="py-4 px-4 text-center text-green-400">‚úì</td>
              </tr>
              <tr>
                <td className="py-4 px-4 text-slate-300">Data Export</td>
                <td className="py-4 px-4 text-center text-red-400">‚úó</td>
                <td className="py-4 px-4 text-center text-green-400">‚úì</td>
                <td className="py-4 px-4 text-center text-green-400">‚úì</td>
              </tr>
              <tr>
                <td className="py-4 px-4 text-slate-300">Priority Support</td>
                <td className="py-4 px-4 text-center text-red-400">‚úó</td>
                <td className="py-4 px-4 text-center text-red-400">‚úó</td>
                <td className="py-4 px-4 text-center text-green-400">‚úì</td>
              </tr>
              <tr>
                <td className="py-4 px-4 text-slate-300">API Access</td>
                <td className="py-4 px-4 text-center text-red-400">‚úó</td>
                <td className="py-4 px-4 text-center text-red-400">‚úó</td>
                <td className="py-4 px-4 text-center text-green-400">‚úì</td>
              </tr>
              <tr>
                <td className="py-4 px-4 text-slate-300">Team Features</td>
                <td className="py-4 px-4 text-center text-red-400">‚úó</td>
                <td className="py-4 px-4 text-center text-red-400">‚úó</td>
                <td className="py-4 px-4 text-center text-green-400">‚úì</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      {/* FAQ Section */}
      <div className="text-center pt-6 sm:pt-8 md:pt-12 border-t border-slate-800 px-2 sm:px-4">
        <h3 className="text-lg sm:text-xl font-serif text-slate-100 mb-4">
          Frequently Asked Questions
        </h3>
        <div className="space-y-4 text-left max-w-2xl mx-auto">
          <div>
            <h4 className="font-semibold text-slate-200 mb-2">Can I change plans anytime?</h4>
            <p className="text-slate-400 text-sm">Yes, you can upgrade or downgrade your plan at any time. Changes take effect immediately.</p>
          </div>
          <div>
            <h4 className="font-semibold text-slate-200 mb-2">Is there a free trial?</h4>
            <p className="text-slate-400 text-sm">All plans come with a 14-day free trial. No credit card required to start.</p>
          </div>
          <div>
            <h4 className="font-semibold text-slate-200 mb-2">What payment methods do you accept?</h4>
            <p className="text-slate-400 text-sm">We accept all major credit cards, PayPal, and bank transfers for Enterprise plans.</p>
          </div>
        </div>
      </div>
    </div>
  );
}
